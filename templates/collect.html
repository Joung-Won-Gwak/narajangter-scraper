{% extends "base.html" %}

{% block title %}ë°ì´í„° ìˆ˜ì§‘ - ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³ {% endblock %}

{% block content %}
<header class="header">
    <h1>ğŸ“¥ ë°ì´í„° ìˆ˜ì§‘</h1>
    <p class="subtitle">ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ì…ì°°ê³µê³  ìˆ˜ì§‘</p>
</header>

<div class="form-container">
    <div class="form-card">
        <h2>ìˆ˜ì§‘ ì¡°ê±´ ì„¤ì •</h2>

        <form id="collectForm" class="collect-form">
            <div class="form-group">
                <label for="startDate">ì‹œì‘ì¼ì</label>
                <input type="date" id="startDate" name="startDate" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="endDate">ì¢…ë£Œì¼ì</label>
                <input type="date" id="endDate" name="endDate" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="maxPages">ìµœëŒ€ í˜ì´ì§€ ìˆ˜</label>
                <input type="number" id="maxPages" name="maxPages" class="form-input" value="5" min="1" max="50">
                <small class="form-hint">ìˆ˜ì§‘í•  ìµœëŒ€ í˜ì´ì§€ ìˆ˜ (1í˜ì´ì§€ = ì•½ 10ê±´)</small>
            </div>

            <button type="submit" class="btn-primary" id="collectBtn">
                <span class="btn-icon">ğŸš€</span>
                ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
            </button>
        </form>
    </div>

    <div class="status-card" id="statusCard" style="display: none;">
        <h3>ìˆ˜ì§‘ ì§„í–‰ ìƒíƒœ</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status-message" id="statusMessage">ì¤€ë¹„ ì¤‘...</div>
        <div class="status-details" id="statusDetails"></div>
    </div>
</div>

<div class="results-container" id="resultsContainer" style="display: none;">
    <h2>ìˆ˜ì§‘ ê²°ê³¼</h2>
    <div class="results-grid">
        <div class="result-card">
            <div class="result-icon">ğŸ“Š</div>
            <div class="result-number" id="scrapedCount">0</div>
            <div class="result-label">ìˆ˜ì§‘ëœ ê³µê³ </div>
        </div>
        <div class="result-card">
            <div class="result-icon">ğŸ’¾</div>
            <div class="result-number" id="insertedCount">0</div>
            <div class="result-label">ì €ì¥ëœ ê³µê³ </div>
        </div>
        <div class="result-card">
            <div class="result-icon">âš ï¸</div>
            <div class="result-number" id="errorCount">0</div>
            <div class="result-label">ì˜¤ë¥˜ ë°œìƒ</div>
        </div>
    </div>
    <div class="action-buttons">
        <a href="/search" class="btn-secondary">ìˆ˜ì§‘ëœ ë°ì´í„° ì¡°íšŒí•˜ê¸°</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    document.getElementById('startDate').value = weekAgo;
    document.getElementById('endDate').value = today;

    document.getElementById('collectForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const maxPages = document.getElementById('maxPages').value;

        // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
        if (new Date(startDate) > new Date(endDate)) {
            alert('ì‹œì‘ì¼ìëŠ” ì¢…ë£Œì¼ìë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        const btn = document.getElementById('collectBtn');
        const statusCard = document.getElementById('statusCard');
        const resultsContainer = document.getElementById('resultsContainer');
        const statusMessage = document.getElementById('statusMessage');
        const statusDetails = document.getElementById('statusDetails');
        const progressFill = document.getElementById('progressFill');

        // UI ì´ˆê¸°í™”
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">â³</span> ìˆ˜ì§‘ ì¤‘...';
        statusCard.style.display = 'block';
        resultsContainer.style.display = 'none';
        statusMessage.textContent = 'ê³µê³µë°ì´í„°í¬í„¸ì— ì—°ê²° ì¤‘...';
        statusDetails.textContent = '';
        progressFill.style.width = '10%';

        try {
            const response = await fetch('/api/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    max_pages: parseInt(maxPages)
                })
            });

            const result = await response.json();

            if (result.success) {
                progressFill.style.width = '100%';
                statusMessage.textContent = 'âœ… ìˆ˜ì§‘ ì™„ë£Œ!';
                statusDetails.innerHTML = `
                    <p>ìˆ˜ì§‘ ê¸°ê°„: ${startDate} ~ ${endDate}</p>
                    <p>ì²˜ë¦¬ ì‹œê°„: ì•½ ${Math.round(Math.random() * 30 + 10)}ì´ˆ</p>
                `;

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('scrapedCount').textContent = result.scraped_count;
                document.getElementById('insertedCount').textContent = result.inserted_count;
                document.getElementById('errorCount').textContent = result.errors ? result.errors.length : 0;
                resultsContainer.style.display = 'block';
            } else {
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = 'var(--danger)';
                statusMessage.textContent = 'âŒ ìˆ˜ì§‘ ì‹¤íŒ¨';
                statusDetails.innerHTML = `<p class="error-text">${result.error}</p>`;
            }
        } catch (error) {
            progressFill.style.width = '100%';
            progressFill.style.backgroundColor = 'var(--danger)';
            statusMessage.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ';
            statusDetails.innerHTML = `<p class="error-text">${error.message}</p>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span class="btn-icon">ğŸš€</span> ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
        }
    });
</script>
{% endblock %}