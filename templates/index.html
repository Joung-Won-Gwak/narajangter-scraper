<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³  ë·°ì–´</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ›ï¸ ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³ </h1>
            <p class="subtitle">ì •ë³´ì‹œìŠ¤í…œ ê°ë¦¬ ê³µê³  í˜„í™©</p>
        </header>

        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ê³µê³ </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayCount">-</div>
                <div class="stat-label">ìµœê·¼ ìˆ˜ì§‘</div>
            </div>
        </div>

        <div class="search-section">
            <button onclick="runScraper()" class="scrape-btn" id="scrapeBtn">ğŸ“¥ ê³µê³  ìˆ˜ì§‘</button>
            <input type="text" id="searchInput" placeholder="ê³µê³ ëª…ìœ¼ë¡œ ê²€ìƒ‰..." class="search-input">
            <button onclick="searchNotices()" class="search-btn">ê²€ìƒ‰</button>
            <button onclick="loadNotices()" class="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="scrapeStatus" class="scrape-status" style="display: none;"></div>

        <div class="table-container">
            <table class="notices-table">
                <thead>
                    <tr>
                        <th>ê³µê³ ë²ˆí˜¸</th>
                        <th>ê³µê³ ëª…</th>
                        <th>ë°œì£¼ê¸°ê´€</th>
                        <th>ì¶”ì •ê°€ê²©</th>
                        <th>ê³µê³ ì¼</th>
                        <th>ë§ˆê°ì¼</th>
                        <th>ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody id="noticesBody">
                    <tr>
                        <td colspan="7" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadNotices() {
            const keyword = document.getElementById('searchInput').value;
            const url = keyword ? `/api/notices?keyword=${encodeURIComponent(keyword)}` : '/api/notices';

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('totalCount').textContent = result.count;
                    document.getElementById('todayCount').textContent = result.count;
                    renderNotices(result.data);
                } else {
                    showError(result.error);
                }
            } catch (error) {
                showError(error.message);
            }
        }

        function renderNotices(notices) {
            const tbody = document.getElementById('noticesBody');

            if (notices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = notices.map(n => `
                <tr>
                    <td class="notice-id">${n.notice_id || '-'}</td>
                    <td class="notice-title">${n.title || '-'}</td>
                    <td class="notice-org">${n.organization || '-'}</td>
                    <td class="notice-price">${n.estimated_price_formatted}</td>
                    <td class="notice-date">${formatDate(n.publish_date)}</td>
                    <td class="notice-deadline">${formatDate(n.deadline_date)}</td>
                    <td class="notice-link">
                        ${n.notice_url ? `<a href="${n.notice_url}" target="_blank" class="detail-link">ìƒì„¸ë³´ê¸°</a>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr.split(' ')[0];
        }

        function showError(message) {
            const tbody = document.getElementById('noticesBody');
            tbody.innerHTML = `<tr><td colspan="7" class="error">ì˜¤ë¥˜: ${message}</td></tr>`;
        }

        function searchNotices() {
            loadNotices();
        }

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchNotices();
        });

        async function runScraper() {
            const btn = document.getElementById('scrapeBtn');
            const status = document.getElementById('scrapeStatus');

            btn.disabled = true;
            btn.textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';
            status.style.display = 'block';
            status.className = 'scrape-status loading';
            status.textContent = 'ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.success) {
                    status.className = 'scrape-status success';
                    status.textContent = `âœ… ìˆ˜ì§‘ ì™„ë£Œ! ${result.scraped_count}ê±´ ìˆ˜ì§‘, ${result.inserted_count}ê±´ ì €ì¥`;
                    loadNotices(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                } else {
                    status.className = 'scrape-status error';
                    status.textContent = `âŒ ìˆ˜ì§‘ ì‹¤íŒ¨: ${result.error}`;
                }
            } catch (error) {
                status.className = 'scrape-status error';
                status.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ ê³µê³  ìˆ˜ì§‘';
                setTimeout(() => { status.style.display = 'none'; }, 5000);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', loadNotices);
    </script>
</body>

</html>