{% extends "base.html" %}

{% block title %}ì œì•ˆì„œ ìƒì„± - ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³ {% endblock %}

{% block content %}
<header class="header">
    <h1>ğŸ“ ì œì•ˆì„œ ìƒì„±</h1>
    <p class="subtitle">AI ê¸°ë°˜ ì œì•ˆì„œ ìë™ ìƒì„±</p>
</header>

<div class="form-container">
    <div class="form-card">
        <h2>ì œì•ˆì„œ ìƒì„± ì •ë³´</h2>

        <form id="proposalForm" class="proposal-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="rfpFile">ì œì•ˆìš”ì²­ì„œ (RFP)</label>
                <div class="file-upload-area" id="rfpUploadArea">
                    <input type="file" id="rfpFile" name="rfpFile" class="file-input" accept=".pdf,.docx,.doc" required>
                    <div class="file-upload-content">
                        <div class="upload-icon">ğŸ“„</div>
                        <p>í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                        <small>PDF, DOCX íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)</small>
                    </div>
                    <div class="file-name" id="rfpFileName" style="display: none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="templateFile">ì œì•ˆì„œ í…œí”Œë¦¿</label>
                <div class="file-upload-area" id="templateUploadArea">
                    <input type="file" id="templateFile" name="templateFile" class="file-input" accept=".docx,.doc">
                    <div class="file-upload-content">
                        <div class="upload-icon">ğŸ“‹</div>
                        <p>í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                        <small>DOCX íŒŒì¼ ì§€ì› (ì„ íƒì‚¬í•­)</small>
                    </div>
                    <div class="file-name" id="templateFileName" style="display: none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="requirements">ì¶”ê°€ ìš”êµ¬ì‚¬í•­</label>
                <textarea id="requirements" name="requirements" class="form-textarea" rows="5"
                    placeholder="ì œì•ˆì„œì— í¬í•¨ë˜ì–´ì•¼ í•  íŠ¹ë³„í•œ ìš”êµ¬ì‚¬í•­ì´ë‚˜ ê°•ì¡°í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <div class="form-group">
                <label for="companyInfo">íšŒì‚¬ ì •ë³´</label>
                <textarea id="companyInfo" name="companyInfo" class="form-textarea" rows="3"
                    placeholder="íšŒì‚¬ëª…, ì£¼ìš” ì‹¤ì , ê°•ì  ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <button type="submit" class="btn-primary" id="generateBtn">
                <span class="btn-icon">âœ¨</span>
                ì œì•ˆì„œ ìƒì„±í•˜ê¸°
            </button>
        </form>
    </div>

    <div class="info-card">
        <h3>ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h3>
        <ul class="info-list">
            <li>ì œì•ˆìš”ì²­ì„œ(RFP)ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ë‚´ìš©ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
            <li>ì œì•ˆì„œ í…œí”Œë¦¿ì´ ìˆë‹¤ë©´ í•´ë‹¹ í˜•ì‹ì— ë§ì¶° ìƒì„±ë©ë‹ˆë‹¤.</li>
            <li>ì¶”ê°€ ìš”êµ¬ì‚¬í•­ì— ê°•ì¡°í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</li>
            <li>ìƒì„±ëœ ì œì•ˆì„œëŠ” DOCX í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<div class="status-card" id="statusCard" style="display: none;">
    <h3>ìƒì„± ì§„í–‰ ìƒíƒœ</h3>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="status-message" id="statusMessage">ì¤€ë¹„ ì¤‘...</div>
</div>

<div class="results-container" id="resultsContainer" style="display: none;">
    <h2>âœ… ì œì•ˆì„œ ìƒì„± ì™„ë£Œ</h2>
    <div class="download-card">
        <div class="download-icon">ğŸ“¥</div>
        <h3>ì œì•ˆì„œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
        <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì œì•ˆì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
        <button class="btn-primary" id="downloadBtn">
            <span class="btn-icon">ğŸ’¾</span>
            ì œì•ˆì„œ ë‹¤ìš´ë¡œë“œ
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // íŒŒì¼ ì—…ë¡œë“œ UI ì²˜ë¦¬
    function setupFileUpload(inputId, areaId, fileNameId) {
        const input = document.getElementById(inputId);
        const area = document.getElementById(areaId);
        const fileName = document.getElementById(fileNameId);

        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileName.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileName.style.display = 'block';
                area.classList.add('has-file');
            }
        });

        area.addEventListener('click', () => input.click());

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('drag-over');
        });

        area.addEventListener('dragleave', () => {
            area.classList.remove('drag-over');
        });

        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('drag-over');

            if (e.dataTransfer.files.length > 0) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }

    setupFileUpload('rfpFile', 'rfpUploadArea', 'rfpFileName');
    setupFileUpload('templateFile', 'templateUploadArea', 'templateFileName');

    document.getElementById('proposalForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const btn = document.getElementById('generateBtn');
        const statusCard = document.getElementById('statusCard');
        const resultsContainer = document.getElementById('resultsContainer');
        const statusMessage = document.getElementById('statusMessage');
        const progressFill = document.getElementById('progressFill');

        // UI ì´ˆê¸°í™”
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">â³</span> ìƒì„± ì¤‘...';
        statusCard.style.display = 'block';
        resultsContainer.style.display = 'none';
        statusMessage.textContent = 'RFP íŒŒì¼ ë¶„ì„ ì¤‘...';
        progressFill.style.width = '20%';

        try {
            // ì‹œë®¬ë ˆì´ì…˜: ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ API í˜¸ì¶œ
            await new Promise(resolve => setTimeout(resolve, 1000));
            statusMessage.textContent = 'AI ëª¨ë¸ë¡œ ì œì•ˆì„œ ìƒì„± ì¤‘...';
            progressFill.style.width = '60%';

            await new Promise(resolve => setTimeout(resolve, 2000));
            statusMessage.textContent = 'í…œí”Œë¦¿ ì ìš© ì¤‘...';
            progressFill.style.width = '90%';

            const response = await fetch('/api/proposal/generate', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                progressFill.style.width = '100%';
                statusMessage.textContent = 'âœ… ìƒì„± ì™„ë£Œ!';
                resultsContainer.style.display = 'block';

                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„¤ì •
                document.getElementById('downloadBtn').onclick = () => {
                    if (result.download_url) {
                        window.location.href = result.download_url;
                    } else {
                        alert('ì œì•ˆì„œ íŒŒì¼ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                };
            } else {
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = 'var(--danger)';
                statusMessage.textContent = `âŒ ìƒì„± ì‹¤íŒ¨: ${result.error}`;
            }
        } catch (error) {
            progressFill.style.width = '100%';
            progressFill.style.backgroundColor = 'var(--danger)';
            statusMessage.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span class="btn-icon">âœ¨</span> ì œì•ˆì„œ ìƒì„±í•˜ê¸°';
        }
    });
</script>
{% endblock %}