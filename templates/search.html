{% extends "base.html" %}

{% block title %}ë°ì´í„° ì¡°íšŒ - ë‚˜ë¼ì¥í„° ì…ì°°ê³µê³ {% endblock %}

{% block content %}
<header class="header">
    <h1>ğŸ” ë°ì´í„° ì¡°íšŒ</h1>
    <p class="subtitle">ìˆ˜ì§‘ëœ ì…ì°°ê³µê³  ê²€ìƒ‰ ë° í•„í„°ë§</p>
</header>

<div class="search-container">
    <div class="filter-card">
        <h2>ê²€ìƒ‰ ì¡°ê±´</h2>

        <form id="searchForm" class="search-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="keyword">í‚¤ì›Œë“œ</label>
                    <input type="text" id="keyword" name="keyword" class="form-input" placeholder="ê³µê³ ëª… ê²€ìƒ‰...">
                </div>

                <div class="form-group">
                    <label for="organization">ë°œì£¼ì²˜</label>
                    <input type="text" id="organization" name="organization" class="form-input" placeholder="ë°œì£¼ê¸°ê´€ëª…...">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="minPrice">ìµœì†Œ ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="minPrice" name="minPrice" class="form-input" placeholder="0" min="0">
                </div>

                <div class="form-group">
                    <label for="maxPrice">ìµœëŒ€ ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="maxPrice" name="maxPrice" class="form-input" placeholder="1000000000"
                        min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">ì…ì°° ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" name="startDate" class="form-input">
                </div>

                <div class="form-group">
                    <label for="endDate">ì…ì°° ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" name="endDate" class="form-input">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <span class="btn-icon">ğŸ”</span>
                    ê²€ìƒ‰
                </button>
                <button type="button" class="btn-secondary" onclick="resetForm()">
                    <span class="btn-icon">ğŸ”„</span>
                    ì´ˆê¸°í™”
                </button>
            </div>
        </form>
    </div>
</div>

<div class="results-summary" id="resultsSummary" style="display: none;">
    <span id="resultsCount">0</span>ê±´ì˜ ê³µê³ ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>

<div class="table-container">
    <table class="notices-table">
        <thead>
            <tr>
                <th>ê³µê³ ë²ˆí˜¸</th>
                <th>ê³µê³ ëª…</th>
                <th>ë°œì£¼ê¸°ê´€</th>
                <th>ì¶”ì •ê°€ê²©</th>
                <th>ê³µê³ ì¼</th>
                <th>ë§ˆê°ì¼</th>
                <th>ìƒì„¸</th>
            </tr>
        </thead>
        <tbody id="noticesBody">
            <tr>
                <td colspan="7" class="no-data">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await searchNotices();
    });

    async function searchNotices() {
        const keyword = document.getElementById('keyword').value;
        const organization = document.getElementById('organization').value;
        const minPrice = document.getElementById('minPrice').value;
        const maxPrice = document.getElementById('maxPrice').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (organization) params.append('organization', organization);
        if (minPrice) params.append('min_price', minPrice);
        if (maxPrice) params.append('max_price', maxPrice);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);

        const url = `/api/notices?${params.toString()}`;

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                renderNotices(result.data);
                document.getElementById('resultsCount').textContent = result.count;
                document.getElementById('resultsSummary').style.display = 'block';
            } else {
                showError(result.error);
            }
        } catch (error) {
            showError(error.message);
        }
    }

    function renderNotices(notices) {
        const tbody = document.getElementById('noticesBody');

        if (notices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        tbody.innerHTML = notices.map(n => `
            <tr>
                <td class="notice-id">${n.notice_id || '-'}</td>
                <td class="notice-title">${n.title || '-'}</td>
                <td class="notice-org">${n.organization || '-'}</td>
                <td class="notice-price">${n.estimated_price_formatted}</td>
                <td class="notice-date">${formatDate(n.publish_date)}</td>
                <td class="notice-deadline">${formatDate(n.deadline_date)}</td>
                <td class="notice-link">
                    ${n.notice_url ? `<a href="${n.notice_url}" target="_blank" class="detail-link">ìƒì„¸ë³´ê¸°</a>` : '-'}
                </td>
            </tr>
        `).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return dateStr.split(' ')[0];
    }

    function showError(message) {
        const tbody = document.getElementById('noticesBody');
        tbody.innerHTML = `<tr><td colspan="7" class="error">ì˜¤ë¥˜: ${message}</td></tr>`;
        document.getElementById('resultsSummary').style.display = 'none';
    }

    function resetForm() {
        document.getElementById('searchForm').reset();
        document.getElementById('noticesBody').innerHTML = '<tr><td colspan="7" class="no-data">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td></tr>';
        document.getElementById('resultsSummary').style.display = 'none';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ë°ì´í„° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
        searchNotices();
    });
</script>
{% endblock %}